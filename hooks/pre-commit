#!/bin/bash
#
# Pre-commit hook for Wolfpack
# Runs verification checks before allowing commits
#
# Installation:
#   cp hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#

echo "üîç Running pre-commit verification..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
FAILED=0

# 1. Run verification script (syntax checks)
echo "üìã Step 1/3: Running syntax verification..."
if ./verify_codebase.sh > /tmp/verify_output.txt 2>&1; then
    echo -e "${GREEN}‚úì Syntax verification passed${NC}"
else
    echo -e "${RED}‚úó Syntax verification failed${NC}"
    cat /tmp/verify_output.txt
    FAILED=1
fi
echo ""

# 2. Run ESLint
echo "üìã Step 2/3: Running ESLint..."
if npm run lint > /tmp/eslint_output.txt 2>&1; then
    echo -e "${GREEN}‚úì ESLint passed${NC}"
else
    echo -e "${RED}‚úó ESLint failed${NC}"
    cat /tmp/eslint_output.txt | grep -A 5 "error\|warning" | head -30
    echo ""
    echo -e "${YELLOW}Run 'npm run lint:fix' to auto-fix issues${NC}"
    FAILED=1
fi
echo ""

# 3. Run Jest tests
echo "üìã Step 3/3: Running Jest tests..."
if npm test > /tmp/jest_output.txt 2>&1; then
    # Show test summary
    grep -E "Test Suites:|Tests:" /tmp/jest_output.txt | tail -2
    echo -e "${GREEN}‚úì All tests passed${NC}"
else
    echo -e "${RED}‚úó Tests failed${NC}"
    cat /tmp/jest_output.txt | grep -A 10 "FAIL\|‚óè"
    FAILED=1
fi
echo ""

# Final result
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}‚úì All checks passed - commit allowed${NC}"
    echo -e "${GREEN}========================================${NC}"
    exit 0
else
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}‚úó Checks failed - commit blocked${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo "Fix the issues above and try again."
    echo "To bypass this hook (NOT recommended):"
    echo "  git commit --no-verify"
    exit 1
fi
